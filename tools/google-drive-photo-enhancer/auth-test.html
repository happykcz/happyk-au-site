<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Auth Test â€” GDrive Enhancer</title>
  <style>
    :root { --bg:#0f1115; --fg:#eaeaea; --muted:#9aa0a6; --accent:#d08f2e }
    html,body{height:100%}
    body{margin:0;color:var(--fg);background:radial-gradient(60% 60% at 50% 40%, #191b22 0%, var(--bg) 60%);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    .card{max-width:720px;margin:8vh auto;padding:24px 20px;background:#12151d;border:1px solid #222633;border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.35)}
    code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: .9rem }
    .row{margin:6px 0}
    .btn{display:inline-block;padding:.5rem .9rem;border:1px solid #2a3040;border-radius:8px;background:#1f2937;color:#eaeaea;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:wait}
    .ok{color:#8ef39c}
    .err{color:#ffb3b3}
  </style>
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <main class="card">
    <h1 style="margin:0 0 8px">Auth Test <span style="color:var(--accent)">GDrive</span></h1>
    <div class="row">Config URL: <code id="cfgUrl"></code></div>
    <div class="row">Resolved clientId: <code id="cid">(loading)</code></div>
    <div class="row">Status: <span id="status">init</span></div>
    <div class="row"><button id="btn" class="btn" disabled>Sign in with Google</button></div>
    <pre id="log" style="white-space:pre-wrap"></pre>
  </main>

  <script>
    (async function(){
      const cfgUrl = location.origin + '/tools/google-drive-photo-enhancer/config.json';
      document.getElementById('cfgUrl').textContent = cfgUrl;
      const log = (m, obj)=>{
        const el=document.getElementById('log');
        el.textContent += '\n' + m + (obj? ' ' + JSON.stringify(obj):'');
      };
      function wait(name){ return new Promise((res,rej)=>{let t=0; const id=setInterval(()=>{ if(window[name]){clearInterval(id); res(window[name]);} if(++t>50){clearInterval(id); rej(new Error('timeout '+name));}},200);});}
      try{
        const r = await fetch(cfgUrl, { cache: 'no-store' });
        const cfg = await r.json();
        const clientId = cfg.clientId || cfg.clientID || cfg.CLIENT_ID || cfg.googleClientId || cfg.google_client_id;
        document.getElementById('cid').textContent = clientId || '(missing)';
        if(!clientId){ document.getElementById('status').textContent = 'clientId missing'; return; }
        const [gapi, google] = await Promise.all([wait('gapi'), wait('google')]);
        await new Promise((res,rej)=> gapi.load('client', { callback: res, onerror: rej }));
        await gapi.client.init({ discoveryDocs:[ 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest' ] });
        const btn = document.getElementById('btn');
        btn.disabled = false; document.getElementById('status').textContent = 'ready';
        const tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: clientId,
          scope: 'https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email',
          callback: async (t)=>{
            if(t && t.access_token){
              log('token ok');
              gapi.client.setToken(t);
              const u = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers:{ Authorization:'Bearer '+t.access_token }});
              const info = await u.json();
              log('userinfo', { email: info.email, name: info.name });
              document.getElementById('status').textContent = 'signed-in';
            }
          },
          error_callback: (e)=>{ log('error', e); document.getElementById('status').textContent = 'error'; }
        });
        btn.onclick = ()=> tokenClient.requestAccessToken();
      }catch(e){ document.getElementById('status').textContent='error'; log('init error', { message: e.message }); }
    })();
  </script>
  </body>
  </html>

